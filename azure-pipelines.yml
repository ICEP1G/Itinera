name: $(date:yyyyMMdd).$(rev:r)  # Définit le format du numéro de build

trigger:
  branches:
    include:
      - main  # Déclenche la pipeline pour tout merge vers la branche main

pool:
  name: 'Self-Hosted agent' # Utilise le pool d'agents nommé "Azure Pipelines"
  vmImage: 'windows-latest'  # Utilise une machine virtuelle Windows pour exécuter le pipeline

variables:
  buildConfiguration: 'Release'  # Configuration de build
  solutionPath: 'Itinera.Client.sln'  # Chemin vers la solution
  dtoProjectPath: 'Itinera.DTOs\Itinera.DTOs.csproj'  # Chemin vers le projet DTO
  nugetFeed: 'your-nuget-feed'  # Nom du feed NuGet où publier le package
  majorVersion: 0  # Numéro de version majeure
  minorVersion: 0  # Numéro de version mineure
  patchVersion: $(Build.BuildId)  # Utilise l'ID de build comme numéro de patch


steps:
- task: UseDotNet@2
  inputs:
    packageType: 'sdk'
    version: '9.x'  # Spécifiez la version du SDK .NET que vous utilisez
    includePreviewVersions: false
  displayName: 'Install .NET SDK'

- script: |
    dotnet workload restore
  displayName: 'Restore .NET Workloads' # Il faut absolument ceci pour faire fonctionner le projet MAUI

- task: NuGetToolInstaller@1
  displayName: 'Install NuGet'  # Installe NuGet sur l'agent de build

- task: NuGetCommand@2
  inputs:
    restoreSolution: '$(solutionPath)'
  displayName: 'Restore NuGet packages'  # Restaure les packages NuGet pour la solution

- task: VSBuild@1
  inputs:
    solution: '$(solutionPath)'
    configuration: '$(buildConfiguration)'
    msbuildArgs: '/t:restore /t:build'
  displayName: 'Build the solution'  # Construit l'ensemble de la solution

- task: VSTest@2
  inputs:
    testAssemblyVer2: |
      **\$(buildConfiguration)\Itinera.Client.Tests.dll
      !**\obj\**
    searchFolder: '$(System.DefaultWorkingDirectory)'
  displayName: 'Execute all unit tests'  # Exécute les tests unitaires

- task: NuGetCommand@2
  inputs:
    command: 'pack'
    packagesToPack: '$(dtoProjectPath)'
    configurationToPack: '$(buildConfiguration)'
    # versioningScheme: 'byBuildNumber'
    ersioningScheme: 'off'
    buildProperties: 'Version=$(majorVersion).$(minorVersion).$(patchVersion)'  # Définit explicitement la version
    includeReferencedProjects: false
    outputDir: '$(Build.ArtifactStagingDirectory)' # indique le répertoire où les fichiers de sortie (les packages NuGet créés) seront placés après l'exécution de la commande pack
  displayName: 'Create the NuGet package for the DTOs .dll'  # Crée le package NuGet pour le projet DTO
  condition: succeeded()  # Exécute uniquement si les étapes précédentes ont réussi

- task: NuGetCommand@2
  inputs:
    command: 'push'
    packagesToPush: '$(Build.ArtifactStagingDirectory)/*.nupkg'
    nuGetFeedType: 'internal'
    publishVstsFeed: '$(nugetFeed)'
    allowPackageConflicts: true
  displayName: 'Publish the NuGet package for the DTOs .dll'  # Publie le package NuGet sur le feed spécifié
  condition: succeeded()  # Exécute uniquement si les étapes précédentes ont réussi

- task: PublishBuildArtifacts@1
  inputs:
    pathToPublish: '$(Build.ArtifactStagingDirectory)'
    artifactName: 'NuGetPackage'
  displayName: 'Publish from the build Artifacts'  # Publie le package NuGet en tant qu'artifact de build
  condition: succeeded()  # Exécute uniquement si les étapes précédentes ont réussi