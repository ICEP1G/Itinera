<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="Itinera.Client.Views.Pages.PlacePage"
             xmlns:toolkit="clr-namespace:CommunityToolkit.Maui.Behaviors;assembly=CommunityToolkit.Maui"
             xmlns:components="clr-namespace:Itinera.Client.Views.Components"
             xmlns:errors="clr-namespace:Itinera.Client.Views.Errors"
             xmlns:converter="clr-namespace:Itinera.Client.Converters"
             Shell.NavBarIsVisible="False"
             x:Name="PlaceContentPage"
             Title="PlacePage">

    <ContentPage.Resources>
        <converter:BoolAndBoolConverter x:Key="BoolAndBoolConverter" />
        <converter:BoolAndStringToBoolConverter x:Key="BoolAndStringToBoolConverter" />
        <converter:ValueNullToBoolConverter x:Key="ValueNullToBoolConverter" />
        <converter:BoolToInvertBoolConverter x:Key="BoolToInvertBoolConverter" />
        <converter:StringNotNullToBoolConverter x:Key="StringNotNullToBoolConverter" />
        <converter:IsFirstCollectionItemConverter x:Key="IsFirstCollectionItemConverter" />
        <converter:ScheduleListWithCommasConverter x:Key="ScheduleListWithCommasConverter" />
        <converter:ValueNullAndBoolFalseToBoolConverter x:Key="ValueNullAndBoolFalseToBoolConverter" />
    </ContentPage.Resources>

    <Grid ZIndex="1">
        <!--Loading-->
        <ActivityIndicator IsRunning="{Binding IsLoadingPlace}" VerticalOptions="Start" TranslationY="120" ZIndex="5"/>

        <!--Start Error container-->
        <VerticalStackLayout 
            Margin="16,0" 
            IsVisible="{Binding ErrorLoadingPlacePageData, Converter={StaticResource StringNotNullToBoolConverter}}"
            ZIndex="1">
            <!--Return button-->
            <Image Grid.Row="1" ZIndex="2" x:Name="ErrorReturnImage"
                    Source="backarrow_icon.png"
                    HeightRequest="18"
                    HorizontalOptions="Start"
                    VerticalOptions="Start"
                    Margin="0,16,0,32">
                <Image.Behaviors>
                    <toolkit:IconTintColorBehavior TintColor="{StaticResource PrimaryText}" />
                </Image.Behaviors>
                <Image.GestureRecognizers>
                    <TapGestureRecognizer Command="{Binding GoBackCommand}" />
                </Image.GestureRecognizers>
            </Image>
            <errors:ErrorSomethingWentWrong ErrorMessage="{Binding ErrorLoadingPlacePageData}" />
        </VerticalStackLayout>
        <!--End Error container-->

        <!--Content-->
        <Grid ZIndex="1">
            <Grid.IsVisible>
                <MultiBinding Converter="{StaticResource ValueNullAndBoolFalseToBoolConverter}">
                    <Binding Path="ErrorLoadingPlacePageData" />
                    <Binding Path="IsLoadingPlace" />
                </MultiBinding>
            </Grid.IsVisible>
            <Grid ZIndex="1">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>
                <components:GeneralSearch Grid.Row="0"/>

                <!--Carousel container-->
                <CarouselView Grid.Row="1" ZIndex="1"
                    ItemsSource="{Binding ImageUrls}"
                    HeightRequest="260"
                    HorizontalScrollBarVisibility="Never"
                    VerticalScrollBarVisibility="Never">
                    <CarouselView.ItemsLayout>
                        <LinearItemsLayout Orientation="Horizontal" SnapPointsAlignment="Center" SnapPointsType="MandatorySingle" />
                    </CarouselView.ItemsLayout>
                    <CarouselView.ItemTemplate>
                        <DataTemplate>
                            <Grid HeightRequest="260" WidthRequest="{Binding Source={x:Reference PlaceContentPage}, Path=Width}">
                                <Image ZIndex="1"
                                    Source="{Binding .}"
                                    Aspect="AspectFill"
                                    VerticalOptions="Center"
                                    HorizontalOptions="Center"/>
                            </Grid>
                        </DataTemplate>
                    </CarouselView.ItemTemplate>
                </CarouselView>

                <!--Return button-->
                <Image Grid.Row="1" ZIndex="2"
                    Source="backarrow_icon.png"
                    HeightRequest="18"
                    HorizontalOptions="Start"
                    VerticalOptions="Start"
                    Margin="8,12,0,0">
                    <Image.Behaviors>
                        <toolkit:IconTintColorBehavior TintColor="{StaticResource LightGrey}" />
                    </Image.Behaviors>
                    <Image.Shadow>
                        <Shadow Brush="Black" Offset="1,4" Radius="4" Opacity="0.3" />
                    </Image.Shadow>
                    <Image.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding GoBackCommand}" />
                    </Image.GestureRecognizers>
                </Image>

                <!--Buttons-->
                <HorizontalStackLayout Grid.Row="1" ZIndex="2"
                    VerticalOptions="Start"
                    HorizontalOptions="End"
                    Margin="0,12,12,0"
                    Spacing="8">
                    <!--Recommand-->
                    <HorizontalStackLayout>
                        <HorizontalStackLayout.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding UpdatePlaceRecommandationCommand}" />
                        </HorizontalStackLayout.GestureRecognizers>
                        <components:ButtonChips BindingContext="{Binding ButtonChipsRecommendation}" />
                    </HorizontalStackLayout>
                    <!--Review-->
                    <HorizontalStackLayout>
                        <HorizontalStackLayout.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding AddOrUpdateReviewCommand}" />
                        </HorizontalStackLayout.GestureRecognizers>
                        <components:ButtonChips BindingContext="{Binding ButtonChipsReview}" />
                    </HorizontalStackLayout>
                </HorizontalStackLayout>

                <!--Add to Placelist-->
                <Border Grid.Row="1" ZIndex="2" Style="{StaticResource BorderMediumButtonFABPrimary}"
                    HorizontalOptions="End"
                    VerticalOptions="End"
                    Margin="16,0,16,52">
                    <Border.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding AddPlaceToPlacelistCommand}" />
                    </Border.GestureRecognizers>
                    <Image Source="addplace_icon.png" HeightRequest="28">
                        <Image.Behaviors>
                            <toolkit:IconTintColorBehavior TintColor="{StaticResource White}" />
                        </Image.Behaviors>
                    </Image>
                </Border>

                <!--Recommendation container-->
                <HorizontalStackLayout Grid.Row="1" ZIndex="2"
                    VerticalOptions="End"
                    Margin="8,0,0,52" 
                    Spacing="12">
                    <Image Source="star_icon.png"
                        IsVisible="{Binding IsFavorite}"
                        WidthRequest="30"
                        HeightRequest="30">
                        <Image.Shadow>
                            <Shadow Brush="Black" Offset="1,4" Radius="4" Opacity="0.5" />
                        </Image.Shadow>
                        <Image.Behaviors>
                            <toolkit:IconTintColorBehavior TintColor="{StaticResource Yellow}" />
                        </Image.Behaviors>
                    </Image>
                    <components:Recommendation RecommendationCount="{Binding RecommendationCount}" Size="Normal" DropShadow="True" />
                </HorizontalStackLayout>

                <!--Place type and website container-->
                <Grid Grid.Row="1" ZIndex="2"
                    VerticalOptions="End"
                    HeightRequest="40"
                    Padding="12,2,16,2"
                    ColumnSpacing="8"
                    BackgroundColor="#CC615D60">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>

                    <Grid Grid.Column="0" ColumnSpacing="10">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>
                        <Image Grid.Column="0"
                            Source="{Binding IconUri}"
                            HeightRequest="20"
                            VerticalOptions="Center">
                            <Image.Behaviors>
                                <toolkit:IconTintColorBehavior TintColor="{StaticResource White}" />
                            </Image.Behaviors>
                        </Image>
                        <Label Grid.Column="1"
                            Text="{Binding PrimaryType}"
                            TextColor="{StaticResource White}"
                            FontSize="16"
                            FontFamily="RobotoMedium"
                            LineBreakMode="TailTruncation"
                            VerticalTextAlignment="Center"/>
                    </Grid>

                    <Grid Grid.Column="1" HorizontalOptions="End" ColumnSpacing="8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>
                        <Label Grid.Column="0"
                            Text="Go to the website"
                            TextColor="{StaticResource White}"
                            TextDecorations="Underline"
                            FontSize="14"
                            FontFamily="RobotoMedium"
                            LineBreakMode="TailTruncation"
                            VerticalTextAlignment="Center"
                            HorizontalOptions="End"/>
                        <Image Grid.Column="1"
                            Source="home_icon.png"
                            HeightRequest="24" />
                        <Grid.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding GoToPlaceWebSiteCommand}" />
                        </Grid.GestureRecognizers>
                    </Grid>

                </Grid>

                <components:TabMenu Grid.Row="2" BindingContext="{Binding TabMenu}" />

                <!--Details container-->
                <Grid Grid.Row="3" IsVisible="{Binding IsOverviewTabSelected}" Padding="16,16,16,0">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>
                    <!--Name and Opening status-->
                    <Grid Grid.Row="0" ColumnSpacing="16" VerticalOptions="Center" Margin="0,0,0,4">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>
                        <Label Grid.Column="0"
                            Text="{Binding Name}"
                            TextColor="{StaticResource PrimaryDarkText}"
                            FontSize="20"
                            FontFamily="RobotoSemiBold"
                            LineBreakMode="TailTruncation"/>
                        <components:PlaceScheduleStatusChips Grid.Column="1" TodaySchedules="{Binding TodaySchedules}" HorizontalOptions="Start" TranslationY="1"/>
                    </Grid>
                    <!--Address-->
                    <Label Grid.Row="1"
                        Text="{Binding Address}"
                        TextColor="{StaticResource PrimaryText}"
                        FontSize="16"
                        FontFamily="RobotoRegular"
                        Margin="0,0,0,16"/>

                    <ScrollView Grid.Row="2">
                        <Grid RowSpacing="12" ColumnSpacing="32" Margin="0,0,0,0">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                            </Grid.RowDefinitions>

                            <Label Grid.Row="0"
                                Text="{Binding Description}"
                                TextColor="{StaticResource PrimaryText}"
                                FontSize="16"
                                FontFamily="RobotoRegular"
                                Margin="0,0,0,16"/>

                            <Grid Grid.Row="1" ColumnDefinitions="110,*">
                                <Label Grid.Column="0"
                                    Text="Phone :"
                                    TextColor="{StaticResource PrimaryText}"
                                    FontSize="16"
                                    FontFamily="RobotoMedium"/>
                                <Label Grid.Column="1"
                                    Text="{Binding PhoneNumber}"
                                    TextColor="{StaticResource Tertiary}"
                                    FontSize="16"
                                    FontFamily="RobotoMedium"/>
                            </Grid>

                            <!--Schedules-->
                            <CollectionView Grid.Row="2" ItemsSource="{Binding ScheduleItems}">
                                <CollectionView.ItemsLayout>
                                    <LinearItemsLayout Orientation="Vertical" ItemSpacing="6" />
                                </CollectionView.ItemsLayout>
                                <CollectionView.ItemTemplate>
                                    <DataTemplate>
                                        <Grid ColumnDefinitions="110, Auto, Auto">
                                            <Grid.GestureRecognizers>
                                                <TapGestureRecognizer Command="{Binding Source={x:Reference PlaceContentPage}, 
                                                    Path=BindingContext.ExpandSchedulesCommand}" CommandParameter="{Binding .}" 
                                                    Tapped="TapGestureRecognizer_Tapped"/>
                                            </Grid.GestureRecognizers>
                                            <Label x:Name="LabelDay" Grid.Column="0"
                                                Text="{Binding Day, StringFormat='{0} :'}"
                                                TextColor="{StaticResource PrimaryText}"
                                                FontSize="16"
                                                FontFamily="RobotoMedium" />
                                            <HorizontalStackLayout Grid.Column="1" BindableLayout.ItemsSource="{Binding Schedules, Converter={StaticResource ScheduleListWithCommasConverter}}">
                                                <BindableLayout.ItemTemplate>
                                                    <DataTemplate>
                                                        <Label x:Name="LabelSchedule"
                                                            Text="{Binding}"
                                                            FontSize="16"
                                                            FontFamily="RobotoMedium"
                                                            Loaded="LabelSchedule_Loaded">
                                                        </Label>
                                                    </DataTemplate>
                                                </BindableLayout.ItemTemplate>
                                            </HorizontalStackLayout>

                                            <Image Grid.Column="2" 
                                                IsVisible="{Binding Index, Converter={StaticResource IsFirstCollectionItemConverter}}"
                                                HorizontalOptions="Start"
                                                Source="arrowdown_icon.png"
                                                Margin="12,0,0,0"
                                                HeightRequest="7">
                                                <Image.Behaviors>
                                                    <toolkit:IconTintColorBehavior TintColor="{StaticResource Tertiary}" />
                                                </Image.Behaviors>
                                            </Image>
                                        </Grid>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>

                            <!--Payment container-->
                            <Grid Grid.Row="3" ColumnDefinitions="110,*">
                                <Label Grid.Column="0" 
                                    Text="Payment :"
                                    TextColor="{StaticResource PrimaryText}"
                                    FontSize="16"
                                    FontFamily="RobotoMedium"/>
                                <FlexLayout Grid.Column="1"
                                    BindableLayout.ItemsSource="{Binding PaymentOptions}"
                                    Wrap="Wrap"
                                    JustifyContent="Start"
                                    AlignContent="Center"
                                    AlignItems="Start"
                                    Padding="-1.6,0,0,0">
                                    <BindableLayout.ItemTemplate>
                                        <DataTemplate>
                                            <Border Grid.Row="2"
                                                HeightRequest="24"
                                                BackgroundColor="{StaticResource Taupe500}"
                                                StrokeShape="RoundRectangle 12,12,12,12"
                                                StrokeThickness="0"
                                                Margin="0.8"
                                                Padding="12,3">
                                                <Label
                                                    Text="{Binding}"
                                                    TextColor="{StaticResource White}"
                                                    FontSize="12"
                                                    FontFamily="RobotoMedium"/>
                                            </Border>
                                        </DataTemplate>
                                    </BindableLayout.ItemTemplate>
                                </FlexLayout>
                            </Grid>

                            <!--PriceRange container-->
                            <Grid Grid.Row="4" ColumnDefinitions="110,*">
                                <Label Grid.Row="4" Grid.Column="0" 
                                    Text="Price :"
                                    TextColor="{StaticResource PrimaryText}"
                                    FontSize="16"
                                    FontFamily="RobotoMedium"/>
                                <HorizontalStackLayout Grid.Row="4" Grid.Column="1"
                                    HeightRequest="23"
                                    Spacing="6">
                                    <Label
                                        Text="{Binding PriceRange}"
                                        TextColor="{StaticResource Tertiary}"
                                        FontSize="16"
                                        FontFamily="RobotoMedium"/>
                                    <HorizontalStackLayout VerticalOptions="Start">
                                        <Image Source="itineros_icon.png" HeightRequest="17" TranslationY="1">
                                            <Image.Behaviors>
                                                <toolkit:IconTintColorBehavior TintColor="{StaticResource Tertiary}" />
                                            </Image.Behaviors>
                                        </Image>
                                        <Border
                                            VerticalOptions="Start"
                                            HeightRequest="14"
                                            BackgroundColor="{StaticResource Primary}"
                                            StrokeThickness="0"
                                            TranslationX="-3"
                                            TranslationY="-2"
                                            Padding="4,0,5,1">
                                            <Border.StrokeShape>
                                                <Ellipse />
                                            </Border.StrokeShape>
                                            <Label x:Name="LabelCount"
                                                VerticalOptions="Center"
                                                HorizontalOptions="Center"
                                                Text="1"
                                                TextColor="{StaticResource White}"
                                                FontFamily="RobotoSemiBold"
                                                FontSize="9"/>
                                        </Border>
                                    </HorizontalStackLayout>
                                </HorizontalStackLayout>
                            </Grid>

                        </Grid>
                    </ScrollView>
                </Grid>

                <!--Loading-->
                <ActivityIndicator Grid.Row="3" IsRunning="{Binding IsLoadingReviews}" VerticalOptions="Start" TranslationY="50">
                    <ActivityIndicator.IsVisible>
                        <MultiBinding Converter="{StaticResource BoolAndBoolConverter}">
                            <Binding Path="IsReviewsTabSelected" />
                            <Binding Path="IsLoadingReviews" />
                        </MultiBinding>
                    </ActivityIndicator.IsVisible>
                </ActivityIndicator>
                <!--Error container-->
                <VerticalStackLayout Grid.Row="3" Margin="16,0">
                    <errors:ErrorSomethingWentWrong ErrorMessage="{Binding ErrorLoadingReviewsData}" />
                    <VerticalStackLayout.IsVisible>
                        <MultiBinding Converter="{StaticResource BoolAndStringToBoolConverter}">
                            <Binding Path="IsReviewsTabSelected" />
                            <Binding Path="ErrorLoadingReviewsData" />
                        </MultiBinding>
                    </VerticalStackLayout.IsVisible>
                </VerticalStackLayout>

                <!--Reviews-->
                <ScrollView Orientation="Vertical" Grid.Row="3" IsVisible="{Binding IsReviewsTabSelected}">
                    <VerticalStackLayout>
                        <CollectionView ItemsSource="{Binding Reviews}" IsVisible="{Binding IsReviewsTabSelected}">
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <components:ReviewHeader BindingContext="{Binding}" />
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>
                </ScrollView>

            </Grid>

        </Grid>
    </Grid>
</ContentPage>